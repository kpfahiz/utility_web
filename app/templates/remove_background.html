{% extends "base.html" %}
{% block title %}Remove Background | Utility WebApp{% endblock %}
{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0">Remove Background</h4>
            </div>
            <div class="card-body">
                <form method="post" enctype="multipart/form-data">
                    <div class="mb-4">
                        <label for="image" class="form-label">Select Image</label>
                        <input type="file" class="form-control" id="image" name="image" accept="image/*" required>
                        <div class="form-text">Supported formats: JPEG, PNG, WEBP</div>
                    </div>

                    <div class="mb-4">
                        <label for="background_color" class="form-label">Background Color (Optional)</label>
                        <div class="input-group">
                            <input type="color" class="form-control form-control-color" id="background_color"
                                name="background_color" value="#ffffff" title="Choose your color">
                            <div class="input-group-text">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="" id="enable_color"
                                        onchange="toggleColorInput()">
                                    <label class="form-check-label" for="enable_color">
                                        Use Solid Color
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="form-text">Check the box to replace transparency with the selected color.</div>
                    </div>

                    <button type="submit" class="btn btn-primary w-100">Remove Background</button>
                </form>

                {% if error %}
                <div class="alert alert-danger mt-3">{{ error }}</div>
                {% endif %}

                {% if processed %}
                <div class="mt-4 text-center">
                    <h5>Result</h5>
                    <div class="row mt-3">
                        <div class="col-md-6 mb-3">
                            <h6>Preview</h6>
                            <!-- Display generated base64 image -->
                            <img src="{{ image_data_uri }}" class="img-fluid border rounded" alt="Processed Image"
                                style="max-height: 400px;">
                        </div>
                        <div class="col-md-6 d-flex flex-column justify-content-center">
                            <ul class="list-group mb-3">
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    Original Size
                                    <span class="badge bg-secondary rounded-pill">{{ "%.2f"|format(original_size_kb) }}
                                        KB</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    Processed Size
                                    <span class="badge bg-success rounded-pill">{{ "%.2f"|format(processed_size_kb) }}
                                        KB</span>
                                </li>
                            </ul>

                            <div class="mb-3">
                                <label for="filename_input" class="form-label">Filename</label>
                                <input type="text" class="form-control" id="filename_input" value="{{ download_name }}">
                            </div>

                            <a href="/download-bg-removed/{{ download_name }}"
                                data-original-href="/download-bg-removed/{{ download_name }}" id="download_btn"
                                class="btn btn-success btn-lg">
                                Download Image
                            </a>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const colorInput = document.getElementById('background_color');
        const checkbox = document.getElementById('enable_color');

        if (colorInput && checkbox) {
            // Initial state
            colorInput.disabled = !checkbox.checked;

            // Toggle logic
            window.toggleColorInput = function () {
                colorInput.disabled = !checkbox.checked;
            };
        }

        // Rename logic
        const filenameInput = document.getElementById('filename_input');
        const downloadBtn = document.getElementById('download_btn');

        if (filenameInput && downloadBtn) {
            // Use data attribute to keep the clean URL source of truth
            const originalHref = downloadBtn.getAttribute('data-original-href');

            filenameInput.addEventListener('input', function () {
                const newName = filenameInput.value.trim();
                console.log("Renaming to:", newName);
                if (newName) {
                    const separator = originalHref.includes('?') ? '&' : '?';
                    downloadBtn.setAttribute('href', `${originalHref}${separator}name=${encodeURIComponent(newName)}`);
                } else {
                    downloadBtn.setAttribute('href', originalHref);
                }
            });
        }
    });
</script>
{% endblock %}